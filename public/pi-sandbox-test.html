<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pi Sandbox Diagnostic Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem;
      background: #0f172a;
      color: #fff;
      line-height: 1.6;
    }
    .status { 
      padding: 1rem; 
      margin: 1rem 0; 
      border-radius: 8px; 
      border-left: 4px solid;
    }
    .success { background: #0f5132; border-color: #198754; }
    .warning { background: #664d03; border-color: #ffc107; }
    .error { background: #58151c; border-color: #dc3545; }
    .info { background: #031633; border-color: #0dcaf0; }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 8px 4px;
      transition: all 0.3s ease;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    pre { 
      background: #1e293b; 
      padding: 1rem; 
      border-radius: 8px; 
      overflow-x: auto; 
      font-size: 14px;
      border: 1px solid #334155;
    }
    .test-section {
      margin: 2rem 0;
      padding: 1.5rem;
      background: #1e293b;
      border-radius: 12px;
      border: 1px solid #334155;
    }
    h2 { color: #60a5fa; margin-top: 0; }
    .browser-info { font-size: 12px; color: #94a3b8; }
  </style>
</head>
<body>
  <h1>üß™ Pi Network Sandbox Diagnostic</h1>
  
  <div class="browser-info">
    <strong>Browser:</strong> <span id="browser-info">Detecting...</span><br>
    <strong>Current URL:</strong> <span id="current-url"></span><br>
    <strong>User Agent:</strong> <span id="user-agent"></span>
  </div>

  <div class="test-section">
    <h2>üîß Environment Check</h2>
    <div id="env-status">Running diagnostics...</div>
  </div>

  <div class="test-section">
    <h2>üì° Pi SDK Loading</h2>
    <div id="sdk-status">Checking Pi SDK...</div>
    <button id="reload-sdk" onclick="reloadPiSdk()">Reload Pi SDK</button>
  </div>

  <div class="test-section">
    <h2>üîê Pi Authentication Test</h2>
    <div id="auth-status">SDK must be loaded first</div>
    <button id="test-auth" onclick="testAuthentication()" disabled>Test Pi Login</button>
    <pre id="auth-result"></pre>
  </div>

  <div class="test-section">
    <h2>üí∞ Pi Payment Test</h2>
    <div id="payment-status">Authentication required first</div>
    <button id="test-payment" onclick="testPayment()" disabled>Test 0.01œÄ Payment</button>
    <pre id="payment-result"></pre>
  </div>

  <div class="test-section">
    <h2>üìã Debug Log</h2>
    <button onclick="clearLog()">Clear Log</button>
    <button onclick="downloadLog()">Download Log</button>
    <pre id="debug-log"></pre>
  </div>

  <script>
    let debugLog = [];
    let piUser = null;
    let piSDKReady = false;

    function log(message, type = 'info') {
      const timestamp = new Date().toISOString();
      const logEntry = `[${timestamp}] ${message}`;
      debugLog.push(logEntry);
      
      console.log(message);
      
      const logElement = document.getElementById('debug-log');
      logElement.textContent = debugLog.join('\n');
      logElement.scrollTop = logElement.scrollHeight;
    }

    function updateStatus(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function clearLog() {
      debugLog = [];
      document.getElementById('debug-log').textContent = '';
    }

    function downloadLog() {
      const blob = new Blob([debugLog.join('\n')], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `pi-sandbox-diagnostic-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Environment detection
    function checkEnvironment() {
      const userAgent = navigator.userAgent;
      const currentUrl = window.location.href;
      
      document.getElementById('user-agent').textContent = userAgent;
      document.getElementById('current-url').textContent = currentUrl;

      let browserInfo = 'Unknown Browser';
      if (userAgent.includes('PiBrowser')) {
        browserInfo = 'ü•ß Pi Browser (Official)';
      } else if (userAgent.includes('Chrome')) {
        browserInfo = 'üåê Chrome (Testing)';
      } else if (userAgent.includes('Firefox')) {
        browserInfo = 'ü¶ä Firefox (Testing)';
      } else if (userAgent.includes('Safari')) {
        browserInfo = 'üß≠ Safari (Testing)';
      } else if (userAgent.includes('Edge')) {
        browserInfo = 'üî∑ Edge (Testing)';
      }

      document.getElementById('browser-info').textContent = browserInfo;

      log(`Environment: ${browserInfo}`);
      log(`User Agent: ${userAgent}`);
      log(`URL: ${currentUrl}`);

      // Check if this looks like a Pi Browser
      const isPiBrowser = userAgent.includes('PiBrowser');
      const isLocalhost = currentUrl.includes('localhost') || currentUrl.includes('127.0.0.1');
      
      let envMessage = '';
      let envType = 'info';

      if (isPiBrowser) {
        envMessage = '‚úÖ Running in Pi Browser - Full sandbox functionality available';
        envType = 'success';
      } else if (isLocalhost) {
        envMessage = '‚ö†Ô∏è Running in regular browser on localhost - Limited testing possible';
        envType = 'warning';
      } else {
        envMessage = '‚ùå Running in regular browser on remote server - Pi SDK may not work';
        envType = 'error';
      }

      updateStatus('env-status', envMessage, envType);
    }

    // Pi SDK loading
    function loadPiSdk() {
      log('üîÑ Loading Pi SDK...');
      
      const existingScript = document.querySelector('script[src*="pi-sdk.js"]');
      if (existingScript) {
        log('‚ö†Ô∏è Removing existing Pi SDK script');
        existingScript.remove();
      }

      if (window.Pi) {
        log('‚ö†Ô∏è Clearing existing Pi object');
        window.Pi = undefined;
      }

      const script = document.createElement('script');
      script.src = 'https://sdk.minepi.com/pi-sdk.js';
      script.async = true;

      script.onload = () => {
        log('‚úÖ Pi SDK script loaded');
        
        let attempts = 0;
        const maxAttempts = 50;
        
        const check = setInterval(() => {
          attempts++;
          
          if (window.Pi && typeof window.Pi.init === 'function') {
            clearInterval(check);
            log('‚úÖ Pi SDK object available');
            
            try {
              window.Pi.init({ version: "2.0", sandbox: true });
              log('‚úÖ Pi SDK initialized in sandbox mode');
              piSDKReady = true;
              
              updateStatus('sdk-status', '‚úÖ Pi SDK loaded and initialized in sandbox mode', 'success');
              document.getElementById('test-auth').disabled = false;
              
            } catch (err) {
              log(`‚ùå Pi SDK initialization failed: ${err.message}`);
              updateStatus('sdk-status', `‚ùå Initialization failed: ${err.message}`, 'error');
            }
          } else if (attempts >= maxAttempts) {
            clearInterval(check);
            log('‚ùå Pi SDK initialization timeout');
            updateStatus('sdk-status', '‚ùå Pi SDK failed to initialize (timeout)', 'error');
          } else {
            log(`‚è≥ Waiting for Pi SDK... (attempt ${attempts}/${maxAttempts})`);
          }
        }, 200);
      };

      script.onerror = (error) => {
        log(`‚ùå Failed to load Pi SDK script: ${error}`);
        updateStatus('sdk-status', '‚ùå Failed to load Pi SDK script', 'error');
      };

      document.head.appendChild(script);
    }

    function reloadPiSdk() {
      piSDKReady = false;
      document.getElementById('test-auth').disabled = true;
      document.getElementById('test-payment').disabled = true;
      updateStatus('sdk-status', 'üîÑ Reloading Pi SDK...', 'info');
      loadPiSdk();
    }

    // Authentication test
    async function testAuthentication() {
      if (!piSDKReady || !window.Pi) {
        log('‚ùå Pi SDK not ready for authentication');
        return;
      }

      log('üîÑ Starting Pi authentication test...');
      updateStatus('auth-status', 'üîÑ Testing authentication...', 'info');
      
      try {
        const scopes = ['username', 'payments'];
        
        const onIncompletePaymentFound = (payment) => {
          log(`‚ö†Ô∏è Incomplete payment found: ${JSON.stringify(payment, null, 2)}`);
        };

        const result = await window.Pi.authenticate(scopes, onIncompletePaymentFound);
        
        piUser = result.user;
        log(`‚úÖ Authentication successful: ${result.user.username} (${result.user.uid})`);
        
        const resultText = JSON.stringify({
          username: result.user.username,
          uid: result.user.uid,
          accessTokenLength: result.accessToken?.length || 0,
          scopes: scopes
        }, null, 2);
        
        document.getElementById('auth-result').textContent = resultText;
        updateStatus('auth-status', `‚úÖ Authenticated as ${result.user.username}`, 'success');
        document.getElementById('test-payment').disabled = false;
        
      } catch (err) {
        log(`‚ùå Authentication failed: ${err.message || err}`);
        updateStatus('auth-status', `‚ùå Authentication failed: ${err.message || err}`, 'error');
        document.getElementById('auth-result').textContent = `Error: ${err.message || err}`;
      }
    }

    // Payment test
    async function testPayment() {
      if (!piUser || !window.Pi) {
        log('‚ùå Authentication required before testing payment');
        return;
      }

      log('üîÑ Starting Pi payment test...');
      updateStatus('payment-status', 'üîÑ Testing payment...', 'info');

      try {
        const paymentData = {
          amount: 0.01,
          memo: "Pi Sandbox Test Payment",
          metadata: { 
            type: 'sandbox_test',
            timestamp: Date.now(),
            user: piUser.username 
          }
        };

        log(`üí∞ Creating payment: ${JSON.stringify(paymentData, null, 2)}`);

        window.Pi.createPayment(paymentData, {
          onReadyForServerApproval: function(paymentId) {
            log(`üîÑ Payment ready for approval: ${paymentId}`);
            document.getElementById('payment-result').textContent = `Payment ID: ${paymentId}\nStatus: Ready for approval`;
          },
          
          onReadyForServerCompletion: function(paymentId, txid) {
            log(`‚úÖ Payment ready for completion: ${paymentId}, Transaction: ${txid}`);
            updateStatus('payment-status', '‚úÖ Payment completed successfully', 'success');
            document.getElementById('payment-result').textContent = `Payment ID: ${paymentId}\nTransaction ID: ${txid}\nStatus: Completed`;
          },
          
          onCancel: function(paymentId) {
            log(`‚ùå Payment cancelled: ${paymentId}`);
            updateStatus('payment-status', '‚ùå Payment cancelled', 'warning');
            document.getElementById('payment-result').textContent = `Payment cancelled: ${paymentId}`;
          },
          
          onError: function(error, payment) {
            log(`‚ùå Payment error: ${error.message || error}`);
            updateStatus('payment-status', `‚ùå Payment error: ${error.message || error}`, 'error');
            document.getElementById('payment-result').textContent = `Error: ${error.message || error}`;
          }
        });

      } catch (err) {
        log(`‚ùå Payment creation failed: ${err.message || err}`);
        updateStatus('payment-status', `‚ùå Payment failed: ${err.message || err}`, 'error');
        document.getElementById('payment-result').textContent = `Error: ${err.message || err}`;
      }
    }

    // Initialize on load
    window.addEventListener('load', () => {
      log('üöÄ Pi Sandbox Diagnostic started');
      checkEnvironment();
      loadPiSdk();
    });

  </script>
</body>
</html> 